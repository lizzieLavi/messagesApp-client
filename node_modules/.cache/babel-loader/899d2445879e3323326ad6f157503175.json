{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useRef}from'react';import{useState,useCallback,useEffect}from'react';import{useConversations}from'../contexts/conversationsprovider';import{useSocket}from'../contexts/socketprovider';import{useUser}from'../contexts/userprovider';import{IconButton}from'@material-ui/core';import InsertEmoticonIcon from'@material-ui/icons/InsertEmoticon';import MicIcon from'@material-ui/icons/Mic';import CloseIcon from'@material-ui/icons/Close';import ImageIcon from'@material-ui/icons/Image';import CheckIcon from'@material-ui/icons/Check';import Picker from'emoji-picker-react';import{useReactMediaRecorder}from\"react-media-recorder\";import axios from'axios';import Message from'./message';import AudioMessage from'./audiomessage';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function ChatBody(props){var _useState=useState(''),_useState2=_slicedToArray(_useState,2),Text=_useState2[0],setText=_useState2[1];var _useSocket=useSocket(),socket=_useSocket.socket;var _useUser=useUser(),info=_useUser.info;var _useConversations=useConversations(),sendMessage=_useConversations.sendMessage,selectedConversation=_useConversations.selectedConversation;var inputRef=useRef(null);var _useState3=useState(false),_useState4=_slicedToArray(_useState3,2),emojiFlag=_useState4[0],setEmojiFlag=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),recordFlag=_useState6[0],setRecordFlag=_useState6[1];var _useReactMediaRecorde=useReactMediaRecorder({audio:true}),status=_useReactMediaRecorde.status,startRecording=_useReactMediaRecorde.startRecording,stopRecording=_useReactMediaRecorde.stopRecording,mediaBlobUrl=_useReactMediaRecorde.mediaBlobUrl,clearBlobUrl=_useReactMediaRecorde.clearBlobUrl;var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),audioBlob=_useState8[0],setAudioBlob=_useState8[1];var setRef=useCallback(function(node){if(node)node.scrollIntoView({smooth:true});},[]);useEffect(function(){function fetchData(){return _fetchData.apply(this,arguments);}function _fetchData(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var audio,data,response,recordURL;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(audioBlob!=null)){_context.next=25;break;}_context.next=3;return fetch(mediaBlobUrl).then(function(res){return res.blob();});case 3:audio=_context.sent;data=new FormData();data.append('file',audio);data.append('resource_type','video');data.append(\"upload_preset\",\"whatsApp_clone\");data.append(\"cloud_name\",\"dsrgpqnyv\");_context.prev=9;_context.next=12;return axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/video/upload\",data);case 12:response=_context.sent;recordURL=response.data.url;recordURL=recordURL.slice(0,-4);recordURL+='mp3';setRecordFlag(false);clearBlobUrl();sendMessage(Text,null,null,recordURL);setRecordFlag(false);_context.next=25;break;case 22:_context.prev=22;_context.t0=_context[\"catch\"](9);console.log(_context.t0);case 25:case\"end\":return _context.stop();}}},_callee,null,[[9,22]]);}));return _fetchData.apply(this,arguments);}fetchData();},[audioBlob]);function typing(e){setText(e.target.value);if(socket.current==null)return;socket.current.emit(\"typing\",{user:info,Conversation:selectedConversation});}function handleSubmit(e){e.preventDefault();sendMessage(Text,false,null,null);setText(' ');}function handleImage(_x){return _handleImage.apply(this,arguments);}function _handleImage(){_handleImage=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(e){var data,response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:data=new FormData();data.append('file',e.target.files[0]);data.append(\"upload_preset\",\"whatsApp_clone\");data.append(\"cloud_name\",\"dsrgpqnyv\");_context2.prev=4;_context2.next=7;return axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data);case 7:response=_context2.sent;props.imageCallback(response.data.url);_context2.next=14;break;case 11:_context2.prev=11;_context2.t0=_context2[\"catch\"](4);console.log(_context2.t0);case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[4,11]]);}));return _handleImage.apply(this,arguments);}function recordStart(){setRecordFlag(true);startRecording();}function handleRecord(){return _handleRecord.apply(this,arguments);}function _handleRecord(){_handleRecord=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var res;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:stopRecording();_context3.next=3;return fetch(mediaBlobUrl);case 3:res=_context3.sent;setAudioBlob(res.blob());case 5:case\"end\":return _context3.stop();}}},_callee3);}));return _handleRecord.apply(this,arguments);}function cancelRecord(){stopRecording();clearBlobUrl();setRecordFlag(false);}function updateRecordingDiv(){var recordDiv=/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(IconButton,{children:/*#__PURE__*/_jsx(CloseIcon,{fontSize:\"large\",style:{color:'red'},onClick:cancelRecord})}),/*#__PURE__*/_jsx(IconButton,{children:/*#__PURE__*/_jsx(CheckIcon,{fontSize:\"large\",style:{color:'green'},onClick:handleRecord})})]});return recordDiv;}var _onEmojiClick=function onEmojiClick(event,emojiObject){setText(Text+emojiObject.emoji);};return/*#__PURE__*/_jsxs(\"div\",{className:\"body_and_footer\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"chat_body\",children:selectedConversation.Messages.map(function(message,index){var lastMessage=selectedConversation.Messages.length-1===index;var sender=message.id===sessionStorage['id']?'chat_message':' chat_message chat_reciever';var image=message.id===sessionStorage['id']?info.imageName:selectedConversation.ConversationImage;return/*#__PURE__*/_jsx(\"div\",{className:sender,ref:lastMessage?setRef:null,children:message.containsRecord?/*#__PURE__*/_jsx(AudioMessage,{message:message,sender:sender,image:image}):/*#__PURE__*/_jsx(Message,{message:message})},index);})}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat_footer_with_stickers\",children:[emojiFlag?/*#__PURE__*/_jsx(Picker,{onEmojiClick:function onEmojiClick(e,emojiObject){return _onEmojiClick(e,emojiObject);},pickerStyle:{width:'100%'}}):'',/*#__PURE__*/_jsxs(\"div\",{className:\"chat_footer\",children:[emojiFlag?/*#__PURE__*/_jsxs(IconButton,{onClick:function onClick(){return setEmojiFlag(false);},children:[/*#__PURE__*/_jsx(CloseIcon,{fontSize:\"large\"}),\" \"]}):'',/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(){return setEmojiFlag(true);},children:/*#__PURE__*/_jsx(InsertEmoticonIcon,{fontSize:\"large\"})}),/*#__PURE__*/_jsx(\"input\",{accept:\"image/*\",className:\"invisibleInput\",id:\"icon-button-file\",type:\"file\",style:{visibility:'hidden'},onChange:handleImage}),/*#__PURE__*/_jsx(\"label\",{htmlFor:\"icon-button-file\",children:/*#__PURE__*/_jsx(IconButton,{component:\"span\",children:/*#__PURE__*/_jsx(ImageIcon,{fontSize:\"large\"})})}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,className:\"message_section\",children:[/*#__PURE__*/_jsx(\"input\",{className:\"message_input\",ref:inputRef,value:Text,onChange:typing,type:\"text\",placeholder:\"type a message\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",children:\" send \"})]}),recordFlag?updateRecordingDiv():/*#__PURE__*/_jsx(IconButton,{onClick:recordStart,children:/*#__PURE__*/_jsx(MicIcon,{fontSize:\"large\"})})]})]})]});}export default ChatBody;","map":{"version":3,"sources":["C:/Users/User/OneDrive/Desktop/whatsapp/myclient/src/components/chatbody.js"],"names":["React","useRef","useState","useCallback","useEffect","useConversations","useSocket","useUser","IconButton","InsertEmoticonIcon","MicIcon","CloseIcon","ImageIcon","CheckIcon","Picker","useReactMediaRecorder","axios","Message","AudioMessage","ChatBody","props","Text","setText","socket","info","sendMessage","selectedConversation","inputRef","emojiFlag","setEmojiFlag","recordFlag","setRecordFlag","audio","status","startRecording","stopRecording","mediaBlobUrl","clearBlobUrl","audioBlob","setAudioBlob","setRef","node","scrollIntoView","smooth","fetchData","fetch","then","res","blob","data","FormData","append","post","response","recordURL","url","slice","console","log","typing","e","target","value","current","emit","user","Conversation","handleSubmit","preventDefault","handleImage","files","imageCallback","recordStart","handleRecord","cancelRecord","updateRecordingDiv","recordDiv","color","onEmojiClick","event","emojiObject","emoji","Messages","map","message","index","lastMessage","length","sender","id","sessionStorage","image","imageName","ConversationImage","containsRecord","width","visibility"],"mappings":"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","sourcesContent":["import React, { useRef } from 'react'\r\nimport { useState ,useCallback,useEffect} from 'react'\r\nimport { useConversations } from '../contexts/conversationsprovider';\r\nimport { useSocket} from '../contexts/socketprovider';\r\nimport { useUser} from '../contexts/userprovider';\r\nimport {IconButton } from '@material-ui/core'\r\nimport InsertEmoticonIcon from '@material-ui/icons/InsertEmoticon';\r\nimport MicIcon from '@material-ui/icons/Mic';\r\nimport CloseIcon from '@material-ui/icons/Close';\r\nimport ImageIcon from '@material-ui/icons/Image';\r\nimport CheckIcon from '@material-ui/icons/Check';\r\nimport Picker from 'emoji-picker-react';\r\nimport { useReactMediaRecorder } from \"react-media-recorder\";\r\nimport axios from 'axios'\r\nimport Message from './message';\r\nimport AudioMessage from './audiomessage';\r\n\r\n\r\n\r\n\r\nfunction ChatBody(props) {\r\n\r\n    const [Text,setText] = useState('')\r\n    const {socket} = useSocket()\r\n    const {info} = useUser()\r\n    const {sendMessage,selectedConversation} = useConversations()\r\n    const inputRef = useRef(null)\r\n  \r\n    const [emojiFlag,setEmojiFlag] = useState(false)\r\n    const [recordFlag,setRecordFlag] =useState(false)\r\n    const {status,startRecording,stopRecording,mediaBlobUrl,clearBlobUrl} = useReactMediaRecorder({audio: true })\r\n    const [audioBlob,setAudioBlob] = useState(null)\r\n\r\n\r\n    const setRef = useCallback((node) => \r\n    {\r\n\r\n      if(node)\r\n         node.scrollIntoView({smooth:true})\r\n    },[])\r\n\r\n\r\n  useEffect( () => {\r\n    async function fetchData() {\r\n    if(audioBlob != null)\r\n    {\r\n      let audio= await fetch(mediaBlobUrl).then(res=> res.blob())\r\n      const data = new FormData();\r\n           \r\n      data.append('file', audio);\r\n      data.append('resource_type', 'video');\r\n      data.append(\"upload_preset\",\"whatsApp_clone\")\r\n      data.append(\"cloud_name\",\"dsrgpqnyv\")\r\n      try{\r\n        let response = await axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/video/upload\",data)\r\n        let recordURL = response.data.url\r\n        recordURL=(recordURL.slice(0,-4))\r\n        recordURL+= 'mp3'\r\n        setRecordFlag(false)\r\n        clearBlobUrl()\r\n        sendMessage(Text,null,null,recordURL)\r\n        setRecordFlag(false)\r\n  \r\n      }catch(err){console.log(err)}\r\n    }\r\n    }\r\n\r\n    fetchData();\r\n \r\n  }, [audioBlob])\r\n\r\n\r\n\r\n    function typing(e)\r\n    {\r\n        setText(e.target.value)\r\n        if (socket.current == null) return;\r\n        socket.current.emit(\"typing\", {user:info,Conversation:selectedConversation})\r\n    }\r\n\r\n    function handleSubmit(e)\r\n    {\r\n      e.preventDefault()\r\n      sendMessage(Text,false,null,null)\r\n\r\n      setText(' ')\r\n    }\r\n\r\n    async function handleImage(e)\r\n    {\r\n      const data = new FormData()\r\n      data.append('file',e.target.files[0])\r\n      data.append(\"upload_preset\",\"whatsApp_clone\")\r\n      data.append(\"cloud_name\",\"dsrgpqnyv\")\r\n      try{\r\n      let response = await axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data)\r\n\r\n      props.imageCallback(response.data.url)\r\n      }catch(err){console.log(err)}\r\n    }\r\n\r\n   function recordStart()\r\n   {\r\n    setRecordFlag(true)\r\n    startRecording()\r\n   }\r\n \r\n    async function handleRecord()\r\n    {\r\n         stopRecording()\r\n         let res = await fetch(mediaBlobUrl)\r\n         setAudioBlob(res.blob())            \r\n    }\r\n\r\n  function cancelRecord()\r\n  {\r\n    stopRecording()\r\n    clearBlobUrl()\r\n    setRecordFlag(false)\r\n  }\r\n\r\n    function updateRecordingDiv()\r\n    {\r\n      let recordDiv = <div>\r\n      <IconButton>\r\n        <CloseIcon fontSize='large' style={{color:'red'}} onClick={cancelRecord} />\r\n      </IconButton>\r\n      <IconButton>\r\n         <CheckIcon fontSize='large'style={{color:'green'}} onClick={handleRecord} />\r\n      </IconButton>\r\n      </div>\r\n\r\n      return recordDiv\r\n  \r\n    }\r\n    \r\n\r\n    const onEmojiClick = (event, emojiObject) => {\r\n        setText(Text + emojiObject.emoji)\r\n      };\r\n\r\n\r\n\r\n    return(\r\n\r\n      <div className= 'body_and_footer'>\r\n        <div className='chat_body'>\r\n        {selectedConversation.Messages.map((message,index)=>\r\n         {\r\n            const lastMessage = selectedConversation.Messages.length -1 === index\r\n            let sender = message.id===sessionStorage['id']? 'chat_message' : ' chat_message chat_reciever'\r\n            let image=message.id===sessionStorage['id']? info.imageName :selectedConversation.ConversationImage\r\n\r\n            return (\r\n                <div key={index} className={sender} ref={lastMessage ? setRef : null}>\r\n                    {message.containsRecord ? \r\n                    <AudioMessage message={message} sender={sender} image={image}/> : <Message message={message}/> }\r\n\r\n                </div> \r\n          )}\r\n        )}\r\n\r\n      </div>\r\n\r\n      <div className='chat_footer_with_stickers'>\r\n         {emojiFlag?  <Picker onEmojiClick={(e,emojiObject)=>onEmojiClick(e,emojiObject)} pickerStyle={{ width: '100%' }}/>: ''}\r\n         <div className='chat_footer'>\r\n           {emojiFlag? <IconButton  onClick={()=>setEmojiFlag(false)}><CloseIcon fontSize='large'/> </IconButton>:''}\r\n           <IconButton  onClick={()=>setEmojiFlag(true)}>\r\n             <InsertEmoticonIcon fontSize='large'/>\r\n           </IconButton>\r\n           <input accept=\"image/*\" className='invisibleInput' id=\"icon-button-file\" type=\"file\"  style={{ visibility: 'hidden'}} onChange={handleImage}/>\r\n           <label htmlFor=\"icon-button-file\">\r\n             <IconButton component=\"span\">\r\n               <ImageIcon  fontSize='large'/>\r\n             </IconButton>\r\n           </label> \r\n\r\n           <form onSubmit={handleSubmit} className='message_section'>\r\n             <input className='message_input' ref={inputRef}  value={Text} onChange={typing} type='text' placeholder='type a message'/>\r\n             <button type='submit' > send </button>\r\n           </form>\r\n           {recordFlag? updateRecordingDiv() :   \r\n           <IconButton onClick={recordStart}>\r\n             <MicIcon fontSize='large'  />\r\n           </IconButton>}\r\n         </div>\r\n\r\n      </div>\r\n\r\n    </div>\r\n\r\n    \r\n)}\r\n\r\nexport default ChatBody\r\n"]},"metadata":{},"sourceType":"module"}