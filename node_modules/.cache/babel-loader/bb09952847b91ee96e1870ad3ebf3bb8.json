{"ast":null,"code":"import _toConsumableArray from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useContext,useCallback,useRef}from\"react\";import{useState,useEffect}from\"react\";import{useUser}from\"./userprovider\";import{useSocket}from\"./socketprovider\";import axios from\"axios\";import{jsx as _jsx}from\"react/jsx-runtime\";var ConversationsContext=/*#__PURE__*/React.createContext();export function useConversations(){return useContext(ConversationsContext);}export function ConversationsProvider(_ref){var children=_ref.children;var _useUser=useUser(),contacts=_useUser.contacts,info=_useUser.info;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),conversations=_useState2[0],setConversations=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),selectedConversation=_useState4[0],setSelectedConversation=_useState4[1];var RefConversations=useRef(conversations);var currentConversationRef=useRef(selectedConversation);var _useSocket=useSocket(),socket=_useSocket.socket,ConnectedUsers=_useSocket.ConnectedUsers;var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),typingFlag=_useState6[0],setTypingFlag=_useState6[1];var _useState7=useState(''),_useState8=_slicedToArray(_useState7,2),currentConversationIsConnected=_useState8[0],setCurrentConversationIsConnected=_useState8[1];var config={headers:{\"x-access-token\":sessionStorage[\"config\"]}};var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),showDetails=_useState10[0],setShowDetails=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),removedFromGroupFlag=_useState12[0],setRemovedFromGroupFlag=_useState12[1];var audio=new Audio('https://res.cloudinary.com/dsrgpqnyv/video/upload/v1630680168/juntos-607_qsfc7i.mp3');var _useState13=useState(true),_useState14=_slicedToArray(_useState13,2),renderFlag=_useState14[0],setRenderFlag=_useState14[1];useEffect(function(){function fetchData(){return _fetchData.apply(this,arguments);}function _fetchData(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(socket.current==null)){_context3.next=2;break;}return _context3.abrupt(\"return\");case 2://when other user updates conversation information, update this user on changes\nsocket.current.on('update-conversation',/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setRenderFlag(true);case 1:case\"end\":return _context.stop();}}},_callee);})));//when user was removed, remove this user from conversation\nsocket.current.on('removed-user',/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:getConversations().then(function(res){setConversations(res);if(selectedConversation){/*if this selected conversation dosn't exists in conversations anymore, this is the deleted user, \r\n          let him know he was deleted and remove this chat from selected conversation*/var checkIfDeleted=res.filter(function(conversation){return conversation._id===selectedConversation._id;});if(checkIfDeleted.length===0)setRemovedFromGroupFlag(true);}});case 1:case\"end\":return _context2.stop();}}},_callee2);})));case 4:case\"end\":return _context3.stop();}}},_callee3);}));return _fetchData.apply(this,arguments);}fetchData();},[selectedConversation]);/*everytime a user is connected/dissconnected/ this user entered new conversation,\r\n check if the current conversation user is connected or not*/useEffect(function(){function fetchData(){return _fetchData2.apply(this,arguments);}function _fetchData2(){_fetchData2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var response;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!selectedConversation){_context4.next=10;break;}if(selectedConversation.isGroup){_context4.next=10;break;}if(!ConnectedUsers.some(function(user){return user.userId===selectedConversation.Participants[0].id;})){_context4.next=6;break;}setCurrentConversationIsConnected('');_context4.next=10;break;case 6:_context4.next=8;return axios.get(\"https://messagesapp1.herokuapp.com/api/logIn/\"+selectedConversation.Participants[0].id,config);case 8:response=_context4.sent;setCurrentConversationIsConnected(response.data.LastSeen);case 10:case\"end\":return _context4.stop();}}},_callee4);}));return _fetchData2.apply(this,arguments);}fetchData();},[ConnectedUsers,selectedConversation]);//on first render,and every time conversation updates, get new conversations from DB\nuseEffect(function(){function fetchData(){return _fetchData3.apply(this,arguments);}function _fetchData3(){_fetchData3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:getConversations().then(function(res){return setConversations(res);});case 1:case\"end\":return _context5.stop();}}},_callee5);}));return _fetchData3.apply(this,arguments);}if(renderFlag){setRenderFlag(false);fetchData();}},[renderFlag]);//when other user is typing, and this user is on this conversation, let him know other user is typing\nuseEffect(function(){if(socket.current==null)return;socket.current.on('user-typing',function(_ref4){var user=_ref4.user,conversationId=_ref4.conversationId;if(selectedConversation){if(selectedConversation._id===conversationId){setTypingFlag(user.name);}}});},[selectedConversation]);//get updated conversations from DB when needed\nfunction getConversations(){return _getConversations.apply(this,arguments);}//on search event, update shown conversations list\nfunction _getConversations(){_getConversations=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var response,ConversationsList;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.prev=0;_context7.next=3;return axios.get(\"https://messagesapp1.herokuapp.com/api/conversations/UserConversations/\"+sessionStorage[\"id\"],config);case 3:response=_context7.sent;ConversationsList=response.data.map(function(conversation){var UpdatedConversation=conversation;/*if this is a private conversation, and the name and picture saved as this user name, \r\n        update the conversation to other user name and picture*/if(!conversation.isGroup&&conversation.Name===sessionStorage['name'])UpdatedConversation=_objectSpread(_objectSpread({},UpdatedConversation),{},{Name:conversation.Participants[0].name,ConversationImage:conversation.Participants[0].image});//update the current shown on screen conversation\nif(selectedConversation){if(selectedConversation._id===UpdatedConversation._id)setSelectedConversation(UpdatedConversation);}return UpdatedConversation;});return _context7.abrupt(\"return\",ConversationsList);case 8:_context7.prev=8;_context7.t0=_context7[\"catch\"](0);console.log(_context7.t0);case 11:case\"end\":return _context7.stop();}}},_callee7,null,[[0,8]]);}));return _getConversations.apply(this,arguments);}function getSearchConverastions(_x){return _getSearchConverastions.apply(this,arguments);}//create new conversation\nfunction _getSearchConverastions(){_getSearchConverastions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(str){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:getConversations().then(function(res){var SearchResult=res.filter(function(conversation){return conversation.Name.includes(str)===true;});setConversations(SearchResult);});case 1:case\"end\":return _context8.stop();}}},_callee8);}));return _getSearchConverastions.apply(this,arguments);}function createConversation(_x2,_x3,_x4,_x5){return _createConversation.apply(this,arguments);}//update existing conversation details when changed \nfunction _createConversation(){_createConversation=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(ids,name,image,groupFlag){var ConversationImage,isGroup,messages,lastMessage,ConversationExists,participants,createdDate,parts,data,response,newConversation,Response;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:ConversationImage=image;isGroup=groupFlag;messages=[];lastMessage='';//no participants chosen\nif(!(ids.length===0)){_context9.next=6;break;}return _context9.abrupt(\"return\",{status:'error',message:'no participants choosen'});case 6://check if conversation already exists and it's not a group.\nConversationExists=null;if(ids.length===1&&!isGroup){ConversationExists=conversations.find(function(conversation){return conversation.Name===name;});}//if already exists, show the existing one\nif(!ConversationExists){_context9.next=12;break;}setSelectedConversation(ConversationExists);//create new conversation\n_context9.next=45;break;case 12://get conversation participants\nparticipants=ids.map(function(id){var addContactToConversation=contacts.filter(function(contact){return id===contact.id;});return addContactToConversation[0];});//add creator to participants\nparticipants.push({id:info.id,name:info.name,phone:info.phone,imageName:info.imageName,LastSeen:info.LastSeen});createdDate='';//if group add creation date,add creation message and upload group picture\nif(!isGroup){_context9.next=34;break;}parts=new Intl.DateTimeFormat('en',{hc:'h12',year:'numeric',month:'2-digit',day:'2-digit',hour:'numeric',minute:'numeric',timeZone:'Asia/Jerusalem'}).formatToParts(new Date()).reduce(function(acc,part){acc[part.type]=part.value;return acc;},Object.create(null));createdDate=\"\".concat(parts.day,\"/\").concat(parts.month,\"/\").concat(parts.year,\" \").concat(parts.hour,\":\").concat(parts.minute);lastMessage={name:\"manager\",message:info.name+\" created this group\",timeSent:'',containsImage:false,containsRecord:false,recordURL:null};messages.push(lastMessage);data=new FormData();data.append('file',ConversationImage);data.append(\"upload_preset\",\"whatsApp_clone\");data.append(\"cloud_name\",\"dsrgpqnyv\");_context9.prev=24;_context9.next=27;return axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data);case 27:response=_context9.sent;ConversationImage=response.data.url;_context9.next=34;break;case 31:_context9.prev=31;_context9.t0=_context9[\"catch\"](24);console.log(_context9.t0);case 34:newConversation={Name:name,creatorId:sessionStorage[\"id\"],Participants:participants,Messages:messages,LastMessage:lastMessage,ConversationImage:ConversationImage,isGroup:isGroup,createdDate:createdDate,description:\"Add Description\"};//updateDB\n_context9.prev=35;_context9.next=38;return axios.post(\"https://messagesapp1.herokuapp.com/api/conversations\",newConversation,config);case 38:Response=_context9.sent;if(Response.data.status===\"created\"){setSelectedConversation(Response.data.conversation);//show conversation only if messages sent or if its A group\nif(Response.data.conversation.Messages.length>0||Response.data.conversation.isGroup===true){setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[Response.data.conversation]);});socket.current.emit('conversation-changed',Response.data.conversation);}}_context9.next=45;break;case 42:_context9.prev=42;_context9.t1=_context9[\"catch\"](35);console.log(_context9.t1);case 45:case\"end\":return _context9.stop();}}},_callee9,null,[[24,31],[35,42]]);}));return _createConversation.apply(this,arguments);}function UpdateConversation(_x6){return _UpdateConversation.apply(this,arguments);}//add message got from other user to conversation\nfunction _UpdateConversation(){_UpdateConversation=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(updatedConversation){var updateDBConv,addCurrentParticipant,participants,response,UpdatedConversations;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:updateDBConv=_objectSpread({},updatedConversation);//if user left the group, dont add him to DB\nif(!updatedConversation.LastMessage.message.includes('left')){addCurrentParticipant={id:info.id,phone:info.phone,name:info.name,image:info.imageName};participants=[].concat(_toConsumableArray(updatedConversation.Participants),[addCurrentParticipant]);updateDBConv=_objectSpread(_objectSpread({},updateDBConv),{},{Participants:participants});}delete updateDBConv._id;_context10.prev=3;_context10.next=6;return axios.put(\"https://messagesapp1.herokuapp.com/api/conversations/\"+selectedConversation._id,updateDBConv,config);case 6:response=_context10.sent;if(response.data.status==='Updated'){UpdatedConversations=[];if(!updatedConversation.LastMessage.message.includes('left')){setSelectedConversation(updatedConversation);conversations.forEach(function(conversation){if(conversation._id===updatedConversation._id)UpdatedConversations.push(updatedConversation);else UpdatedConversations.push(conversation);});}else{UpdatedConversations=conversations.filter(function(conversation){return conversation._id!==selectedConversation._id;});setSelectedConversation();}//if user where removed by admin, send to user deleted case, so server let him know he was deleted\nif(updatedConversation.LastMessage.message.includes('removed'))socket.current.emit('user-deleted',selectedConversation);else socket.current.emit('conversation-changed',selectedConversation);setConversations(UpdatedConversations);}_context10.next=13;break;case 10:_context10.prev=10;_context10.t0=_context10[\"catch\"](3);console.log(_context10.t0);case 13:case\"end\":return _context10.stop();}}},_callee10,null,[[3,10]]);}));return _UpdateConversation.apply(this,arguments);}var addMessageToConversation=useCallback(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(_ref5){var UpdatedConv,ConversationExists,newListOfConversations,newConversation;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:UpdatedConv=_ref5.UpdatedConv;//voice alert\naudio.play();ConversationExists=false;//use refConversations to void infinite loop\nnewListOfConversations=RefConversations.current.map(function(conversation){if(conversation._id===UpdatedConv._id){ConversationExists=true;var newConv=_objectSpread(_objectSpread({},conversation),{},{Messages:UpdatedConv.Messages,LastMessage:UpdatedConv.LastMessage});if(currentConversationRef.current){if(currentConversationRef.current._id===UpdatedConv._id)setSelectedConversation(newConv);}return newConv;}else return conversation;});// if this is a new conversation first message, update user conversations\nif(!ConversationExists){if(!UpdatedConv.isGroup){newConversation=_objectSpread(_objectSpread({},UpdatedConv),{},{Name:UpdatedConv.Participants[0].name,ConversationImage:UpdatedConv.Participants[0].imageName});setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[newConversation]);});}else setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[UpdatedConv]);});}else setConversations(newListOfConversations);case 5:case\"end\":return _context6.stop();}}},_callee6);}));return function(_x7){return _ref6.apply(this,arguments);};}(),[setConversations]);//handle messages socket\nuseEffect(function(){if(socket.current==null)return;RefConversations.current=conversations;currentConversationRef.current=selectedConversation;socket.current.on(\"receive-message\",addMessageToConversation);return function(){return socket.current.off(\"receive-message\",addMessageToConversation);};},[conversations,selectedConversation]);//update the message sender conversations\nvar updateSenderConversation=function updateSenderConversation(AddMessage){var ConversationExists=false;setSelectedConversation(AddMessage);var newListOfConcversations=conversations.map(function(conversation){if(conversation._id===AddMessage._id){ConversationExists=true;return AddMessage;}else return conversation;});if(ConversationExists){setConversations(newListOfConcversations);}else setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[AddMessage]);});};//send new message to chat users\nfunction sendMessage(text,imageFlag,imageURL,recordURL){var parts=new Intl.DateTimeFormat('en',{hc:'h12',year:'numeric',month:'2-digit',day:'2-digit',hour:'numeric',minute:'numeric',timeZone:'Asia/Jerusalem'}).formatToParts(new Date()).reduce(function(acc,part){acc[part.type]=part.value;return acc;},Object.create(null));var time=\"\".concat(parts.day,\"/\").concat(parts.month,\"/\").concat(parts.year,\"  \").concat(parts.hour,\":\").concat(parts.minute);var recordFlag=false;if(recordURL!=null)recordFlag=true;var CurrentMessage={id:info.id,name:info.name,message:text,timeSent:time,containsImage:imageFlag,containsRecord:recordFlag,recordURL:recordURL};if(imageFlag===true)CurrentMessage=_objectSpread(_objectSpread({},CurrentMessage),{},{imageURL:imageURL});var sender={id:info.id,phone:info.phone,name:info.name,image:info.imageName};var AddMessage=_objectSpread(_objectSpread({},selectedConversation),{},{Messages:[].concat(_toConsumableArray(selectedConversation.Messages),[CurrentMessage]),LastMessage:CurrentMessage});socket.current.emit(\"send-message\",{sender:sender,UpdatedConversation:AddMessage,conversationId:selectedConversation._id});updateSenderConversation(AddMessage);}return/*#__PURE__*/_jsx(ConversationsContext.Provider,{value:{sendMessage:sendMessage,conversations:conversations,createConversation:createConversation,setConversations:setConversations,setSelectedConversation:setSelectedConversation,selectedConversation:selectedConversation,currentConversationIsConnected:currentConversationIsConnected,typingFlag:typingFlag,setTypingFlag:setTypingFlag,getSearchConverastions:getSearchConverastions,showDetails:showDetails,setShowDetails:setShowDetails,UpdateConversation:UpdateConversation,removedFromGroupFlag:removedFromGroupFlag,setRemovedFromGroupFlag:setRemovedFromGroupFlag},children:children});}","map":{"version":3,"sources":["C:/Users/User/OneDrive/Desktop/whatsapp/myclient/src/contexts/conversationsprovider.js"],"names":["React","useContext","useCallback","useRef","useState","useEffect","useUser","useSocket","axios","ConversationsContext","createContext","useConversations","ConversationsProvider","children","contacts","info","conversations","setConversations","selectedConversation","setSelectedConversation","RefConversations","currentConversationRef","socket","ConnectedUsers","typingFlag","setTypingFlag","currentConversationIsConnected","setCurrentConversationIsConnected","config","headers","sessionStorage","showDetails","setShowDetails","removedFromGroupFlag","setRemovedFromGroupFlag","audio","Audio","renderFlag","setRenderFlag","fetchData","current","on","getConversations","then","res","checkIfDeleted","filter","conversation","_id","length","isGroup","some","user","userId","Participants","id","get","response","data","LastSeen","conversationId","name","ConversationsList","map","UpdatedConversation","Name","ConversationImage","image","console","log","getSearchConverastions","str","SearchResult","includes","createConversation","ids","groupFlag","messages","lastMessage","status","message","ConversationExists","find","participants","addContactToConversation","contact","push","phone","imageName","createdDate","parts","Intl","DateTimeFormat","hc","year","month","day","hour","minute","timeZone","formatToParts","Date","reduce","acc","part","type","value","Object","create","timeSent","containsImage","containsRecord","recordURL","FormData","append","post","url","newConversation","creatorId","Messages","LastMessage","description","Response","prevConversations","emit","UpdateConversation","updatedConversation","updateDBConv","addCurrentParticipant","put","UpdatedConversations","forEach","addMessageToConversation","UpdatedConv","play","newListOfConversations","newConv","off","updateSenderConversation","AddMessage","newListOfConcversations","sendMessage","text","imageFlag","imageURL","time","recordFlag","CurrentMessage","sender"],"mappings":"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","sourcesContent":["import React, { useContext, useCallback, useRef } from \"react\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useUser } from \"./userprovider\";\r\nimport { useSocket } from \"./socketprovider\";\r\nimport axios from \"axios\";\r\n\r\n\r\n\r\nconst ConversationsContext = React.createContext();\r\n\r\nexport function useConversations() \r\n{\r\n  return useContext(ConversationsContext);\r\n}\r\n\r\nexport function ConversationsProvider({children }) \r\n{\r\n\r\n  const {contacts, info} = useUser();\r\n  const [conversations, setConversations] = useState([]);\r\n  const [selectedConversation, setSelectedConversation] = useState();\r\n  const RefConversations = useRef(conversations);\r\n  const currentConversationRef = useRef(selectedConversation);\r\n  const {socket, ConnectedUsers} = useSocket();\r\n  const [typingFlag,setTypingFlag] =useState('')\r\n  const [currentConversationIsConnected,setCurrentConversationIsConnected] = useState('')\r\n  const config = { headers: { \"x-access-token\": sessionStorage[\"config\"] } };\r\n  const [showDetails,setShowDetails] =useState(false)\r\n  const [removedFromGroupFlag,setRemovedFromGroupFlag] = useState(false)\r\n  const audio = new Audio('https://res.cloudinary.com/dsrgpqnyv/video/upload/v1630680168/juntos-607_qsfc7i.mp3');\r\n  const [renderFlag,setRenderFlag]=useState(true)\r\n\r\n\r\n  useEffect(()=>\r\n  {\r\n    async function fetchData() \r\n    {\r\n      if(socket.current ==null ) return;\r\n\r\n      //when other user updates conversation information, update this user on changes\r\n      socket.current.on('update-conversation',async ()=>\r\n      {\r\n        setRenderFlag(true)\r\n      })\r\n\r\n\r\n    //when user was removed, remove this user from conversation\r\n    socket.current.on('removed-user',async ()=>\r\n    {\r\n      getConversations().then(res=> \r\n      {\r\n        setConversations(res)\r\n        if(selectedConversation)\r\n        {\r\n          /*if this selected conversation dosn't exists in conversations anymore, this is the deleted user, \r\n          let him know he was deleted and remove this chat from selected conversation*/\r\n          let checkIfDeleted=res.filter(conversation=> conversation._id === selectedConversation._id)\r\n          if(checkIfDeleted.length === 0 ) \r\n            setRemovedFromGroupFlag(true)\r\n\r\n        }\r\n\r\n      })\r\n    \r\n    })\r\n  }\r\n\r\n  fetchData();\r\n\r\n  },[selectedConversation])\r\n\r\n/*everytime a user is connected/dissconnected/ this user entered new conversation,\r\n check if the current conversation user is connected or not*/\r\n  useEffect( ()=>\r\n  {\r\n    async function fetchData() \r\n    {\r\n\r\n      if(selectedConversation)\r\n      {\r\n        if(!selectedConversation.isGroup)\r\n        {\r\n         if(ConnectedUsers.some(user=> user.userId ===selectedConversation.Participants[0].id))\r\n        {\r\n          setCurrentConversationIsConnected('')\r\n        }\r\n        else\r\n        {\r\n          let response = await axios.get(\"https://messagesapp1.herokuapp.com/api/logIn/\"+ selectedConversation.Participants[0].id,config)\r\n          setCurrentConversationIsConnected(response.data.LastSeen)\r\n        }\r\n     }\r\n    }\r\n  }\r\n\r\n  fetchData();\r\n\r\n  },[ConnectedUsers,selectedConversation])\r\n\r\n\r\n  //on first render,and every time conversation updates, get new conversations from DB\r\n  useEffect(() =>\r\n  {\r\n\r\n    async function fetchData() \r\n    {\r\n      getConversations().then(res=> setConversations(res))\r\n    }\r\n\r\n    if(renderFlag)\r\n    {\r\n      setRenderFlag(false)\r\n      fetchData();\r\n    }\r\n    \r\n  }, [renderFlag]);\r\n\r\n  //when other user is typing, and this user is on this conversation, let him know other user is typing\r\n  useEffect(() =>\r\n  {\r\n\r\n    if(socket.current ==null ) return;\r\n    socket.current.on('user-typing',({user,conversationId})=>\r\n    {\r\n      if(selectedConversation)\r\n      {\r\n        if(selectedConversation._id === conversationId)\r\n        {\r\n           setTypingFlag(user.name)\r\n        }\r\n      }\r\n    })\r\n\r\n  },[selectedConversation])\r\n\r\n  //get updated conversations from DB when needed\r\n  async function getConversations()\r\n  {\r\n\r\n    try\r\n    {\r\n      let response = await axios.get(\"https://messagesapp1.herokuapp.com/api/conversations/UserConversations/\" +sessionStorage[\"id\"],config);\r\n      let ConversationsList = response.data.map((conversation) =>\r\n      {\r\n        let UpdatedConversation= conversation\r\n\r\n        /*if this is a private conversation, and the name and picture saved as this user name, \r\n        update the conversation to other user name and picture*/\r\n        if (!conversation.isGroup && conversation.Name ===  sessionStorage['name'])\r\n          UpdatedConversation = { ...UpdatedConversation,Name: conversation.Participants[0].name,ConversationImage:conversation.Participants[0].image}\r\n\r\n\r\n        //update the current shown on screen conversation\r\n        if(selectedConversation)\r\n        {\r\n          if(selectedConversation._id === UpdatedConversation._id)\r\n            setSelectedConversation(UpdatedConversation)\r\n        }\r\n\r\n         return UpdatedConversation;\r\n\r\n      })\r\n\r\n      return ConversationsList \r\n\r\n    } catch (err) {console.log(err);}\r\n\r\n  }\r\n\r\n  //on search event, update shown conversations list\r\n  async function getSearchConverastions(str)\r\n  {\r\n    getConversations().then(res=>\r\n    {\r\n      let SearchResult = res.filter(conversation=> \r\n      conversation.Name.includes(str) ===true)\r\n      setConversations(SearchResult)\r\n    })\r\n\r\n  }\r\n        \r\n\r\n  //create new conversation\r\n  async function createConversation(ids, name, image,groupFlag)\r\n  {\r\n\r\n    let ConversationImage = image;\r\n    let isGroup = groupFlag;\r\n    let messages = []\r\n    let lastMessage=''\r\n\r\n\r\n    //no participants chosen\r\n    if (ids.length === 0) {\r\n      return {status:'error',message:'no participants choosen'};\r\n    }\r\n\r\n    //check if conversation already exists and it's not a group.\r\n    let ConversationExists = null;\r\n    if (ids.length === 1 && !isGroup) {\r\n      ConversationExists = conversations.find(\r\n        (conversation) => conversation.Name === name\r\n      );\r\n    }\r\n\r\n\r\n    //if already exists, show the existing one\r\n    if (ConversationExists) setSelectedConversation(ConversationExists);\r\n\r\n    //create new conversation\r\n    else {\r\n\r\n      //get conversation participants\r\n      const participants = ids.map((id) => \r\n      {\r\n        let addContactToConversation = contacts.filter(\r\n          (contact) => id === contact.id\r\n        );\r\n        return addContactToConversation[0];\r\n      });\r\n\r\n\r\n      //add creator to participants\r\n      participants.push({\r\n        id: info.id,\r\n        name: info.name,\r\n        phone: info.phone,\r\n        imageName: info.imageName,\r\n        LastSeen: info.LastSeen\r\n      });\r\n\r\n      let createdDate=''\r\n\r\n      //if group add creation date,add creation message and upload group picture\r\n      if (isGroup) \r\n      {\r\n        let parts = new Intl.DateTimeFormat('en', {\r\n          hc: 'h12',\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: 'numeric',\r\n          minute: 'numeric',\r\n          timeZone:'Asia/Jerusalem'})\r\n        .formatToParts(new Date())\r\n        .reduce((acc, part) => {\r\n          acc[part.type] = part.value;\r\n          return acc;\r\n        }, Object.create(null));\r\n\r\n        createdDate= `${parts.day}/${parts.month}/${parts.year} ${parts.hour}:${parts.minute}`;\r\n\r\n        lastMessage={name:\"manager\",message: info.name +\" created this group\",timeSent:'',containsImage:false,containsRecord:false,recordURL:null}\r\n        messages.push(lastMessage)\r\n\r\n        const data = new FormData()\r\n        data.append('file',ConversationImage)\r\n        data.append(\"upload_preset\",\"whatsApp_clone\")\r\n        data.append(\"cloud_name\",\"dsrgpqnyv\")\r\n        try\r\n        {\r\n          let response = await axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data)\r\n          ConversationImage = response.data.url;\r\n\r\n        }catch(err){console.log(err)}\r\n   \r\n      }\r\n    \r\n      let newConversation = \r\n      {\r\n        Name: name,\r\n        creatorId: sessionStorage[\"id\"],\r\n        Participants: participants,\r\n        Messages: messages,\r\n        LastMessage:lastMessage,\r\n        ConversationImage: ConversationImage,\r\n        isGroup:isGroup,\r\n        createdDate:createdDate,\r\n        description: \"Add Description\",\r\n      };\r\n\r\n      //updateDB\r\n      try \r\n      {\r\n        let Response = await axios.post(\r\n          \"https://messagesapp1.herokuapp.com/api/conversations\",\r\n          newConversation,\r\n          config\r\n        );\r\n\r\n        if (Response.data.status === \"created\") \r\n        {\r\n          setSelectedConversation(Response.data.conversation);\r\n\r\n          //show conversation only if messages sent or if its A group\r\n          if (Response.data.conversation.Messages.length > 0  || Response.data.conversation.isGroup === true)\r\n          {\r\n            setConversations((prevConversations) => {\r\n              return [...prevConversations, Response.data.conversation];\r\n            });\r\n            socket.current.emit('conversation-changed',Response.data.conversation)\r\n          }\r\n        }\r\n      }catch (err) {console.log(err);}\r\n    }\r\n  }\r\n\r\n\r\n  //update existing conversation details when changed \r\n  async function UpdateConversation(updatedConversation)\r\n  {\r\n\r\n    let updateDBConv={...updatedConversation}\r\n\r\n    //if user left the group, dont add him to DB\r\n    if(!(updatedConversation.LastMessage.message.includes('left')))\r\n    {\r\n      let addCurrentParticipant= {id: info.id,phone: info.phone,name: info.name,image: info.imageName,}\r\n      let participants=[...updatedConversation.Participants,addCurrentParticipant]\r\n      updateDBConv={...updateDBConv,Participants:participants}\r\n    }\r\n\r\n    delete updateDBConv._id\r\n\r\n    try\r\n    {\r\n      let response=await axios.put(\"https://messagesapp1.herokuapp.com/api/conversations/\"+ selectedConversation._id,updateDBConv,config)\r\n      if(response.data.status==='Updated')\r\n      {\r\n        let UpdatedConversations=[]\r\n        if(!(updatedConversation.LastMessage.message.includes('left')))\r\n        {\r\n          setSelectedConversation(updatedConversation)\r\n          conversations.forEach(conversation=>\r\n          { \r\n            if(conversation._id===updatedConversation._id)    \r\n              UpdatedConversations.push(updatedConversation)\r\n            else UpdatedConversations.push(conversation)\r\n\r\n          })\r\n        }\r\n        else\r\n        {\r\n          UpdatedConversations=conversations.filter(conversation=> conversation._id !== selectedConversation._id)\r\n          setSelectedConversation()\r\n        }\r\n\r\n\r\n        //if user where removed by admin, send to user deleted case, so server let him know he was deleted\r\n        if(updatedConversation.LastMessage.message.includes('removed'))\r\n          socket.current.emit('user-deleted',selectedConversation)\r\n        else\r\n          socket.current.emit('conversation-changed',selectedConversation)\r\n\r\n        setConversations(UpdatedConversations)\r\n              \r\n      }\r\n    }catch(err){console.log(err)}\r\n  }\r\n\r\n\r\n\r\n  //add message got from other user to conversation\r\n  const addMessageToConversation = useCallback(async ({ UpdatedConv }) =>\r\n  {\r\n\r\n    //voice alert\r\n    audio.play()\r\n\r\n    let ConversationExists = false;\r\n\r\n    //use refConversations to void infinite loop\r\n    let newListOfConversations = RefConversations.current.map((conversation) =>\r\n    {\r\n      if (conversation._id === UpdatedConv._id) \r\n      {\r\n        ConversationExists = true;\r\n        let newConv = \r\n        { ...conversation,\r\n          Messages: UpdatedConv.Messages,\r\n          LastMessage: UpdatedConv.LastMessage,};\r\n          if (currentConversationRef.current) \r\n          {\r\n           if (currentConversationRef.current._id === UpdatedConv._id)\r\n             setSelectedConversation(newConv);\r\n          }\r\n\r\n        return newConv;\r\n\r\n      }\r\n      else return conversation;\r\n    });\r\n\r\n   // if this is a new conversation first message, update user conversations\r\n    if (!ConversationExists) \r\n    {\r\n      if (!UpdatedConv.isGroup)\r\n      {\r\n        let newConversation = \r\n        { ...UpdatedConv,\r\n        Name: UpdatedConv.Participants[0].name,\r\n        ConversationImage: UpdatedConv.Participants[0].imageName,\r\n        };\r\n\r\n        setConversations((prevConversations) => [...prevConversations, newConversation ]);\r\n      } \r\n      else\r\n        setConversations((prevConversations) => [...prevConversations,UpdatedConv]);\r\n    } \r\n    else setConversations(newListOfConversations);\r\n  },[setConversations]);\r\n\r\n\r\n  //handle messages socket\r\n  useEffect(() => \r\n  {\r\n\r\n    if (socket.current == null) return;\r\n    \r\n    RefConversations.current = conversations;\r\n    currentConversationRef.current = selectedConversation;\r\n    socket.current.on(\"receive-message\", addMessageToConversation);\r\n\r\n    return () =>\r\n      socket.current.off(\"receive-message\", addMessageToConversation);\r\n  },[conversations, selectedConversation]);\r\n\r\n\r\n\r\n  //update the message sender conversations\r\n  const updateSenderConversation = (AddMessage) => \r\n  {\r\n\r\n    let ConversationExists = false;\r\n    setSelectedConversation(AddMessage);\r\n\r\n    let newListOfConcversations = conversations.map((conversation) => \r\n    {\r\n      if (conversation._id === AddMessage._id) \r\n      {\r\n        ConversationExists = true;\r\n        return AddMessage;\r\n      } \r\n      else return conversation;\r\n\r\n    });\r\n\r\n    if (ConversationExists) \r\n    {\r\n      setConversations(newListOfConcversations);\r\n    } \r\n    else\r\n      setConversations((prevConversations) => [...prevConversations,AddMessage]);\r\n  };\r\n\r\n\r\n\r\n  //send new message to chat users\r\n  function sendMessage(text,imageFlag,imageURL,recordURL) {\r\n\r\n\r\n    let parts = new Intl.DateTimeFormat('en', {\r\n    hc: 'h12',\r\n    year: 'numeric',\r\n    month: '2-digit',\r\n    day: '2-digit',\r\n    hour: 'numeric',\r\n    minute: 'numeric',\r\n    timeZone:'Asia/Jerusalem'})\r\n    .formatToParts(new Date())\r\n    .reduce((acc, part) => \r\n    {\r\n      acc[part.type] = part.value;\r\n      return acc;\r\n    }, Object.create(null));\r\n\r\n    let time = `${parts.day}/${parts.month}/${parts.year}  ${parts.hour}:${parts.minute}`;\r\n\r\n    let recordFlag= false\r\n\r\n    if(recordURL!=null)\r\n       recordFlag=true\r\n    \r\n    let CurrentMessage = { id: info.id, name: info.name, message: text  ,timeSent: time ,containsImage: imageFlag,containsRecord:recordFlag,recordURL:recordURL};\r\n    if(imageFlag ===true)\r\n       CurrentMessage= {...CurrentMessage,imageURL:imageURL}\r\n    \r\n    let sender = \r\n    {\r\n      id: info.id,\r\n      phone: info.phone,\r\n      name: info.name,\r\n      image: info.imageName,\r\n    };\r\n\r\n    let AddMessage = \r\n    {...selectedConversation,\r\n      Messages: [...selectedConversation.Messages, CurrentMessage],\r\n      LastMessage: CurrentMessage,\r\n    };\r\n\r\n    socket.current.emit(\"send-message\", \r\n    {\r\n      sender: sender,\r\n      UpdatedConversation: AddMessage,\r\n      conversationId: selectedConversation._id,\r\n    });\r\n\r\n    updateSenderConversation(AddMessage);\r\n  }\r\n\r\n  return (\r\n    <ConversationsContext.Provider\r\n      value={{\r\n        sendMessage,\r\n        conversations,\r\n        createConversation,\r\n        setConversations,\r\n        setSelectedConversation,\r\n        selectedConversation,\r\n        currentConversationIsConnected,\r\n        typingFlag,\r\n        setTypingFlag,\r\n        getSearchConverastions,\r\n        showDetails,\r\n        setShowDetails,\r\n        UpdateConversation,\r\n        removedFromGroupFlag,\r\n        setRemovedFromGroupFlag\r\n      \r\n      }}\r\n    >\r\n      {children}\r\n    </ConversationsContext.Provider>\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}