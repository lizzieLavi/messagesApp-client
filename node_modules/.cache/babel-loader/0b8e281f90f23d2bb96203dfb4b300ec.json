{"ast":null,"code":"import _toConsumableArray from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Users/User/OneDrive/Desktop/whatsapp/myclient/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useContext,useCallback,useRef}from\"react\";import{useState,useEffect}from\"react\";import{useUser}from\"./userprovider\";import{useSocket}from\"./socketprovider\";import axios from\"axios\";import Conversations from\"../components/conversations\";import{jsx as _jsx}from\"react/jsx-runtime\";var ConversationsContext=/*#__PURE__*/React.createContext();export function useConversations(){return useContext(ConversationsContext);}export function ConversationsProvider(_ref){var id=_ref.id,children=_ref.children;var _useUser=useUser(),contacts=_useUser.contacts,info=_useUser.info;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),conversations=_useState2[0],setConversations=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),selectedConversation=_useState4[0],setSelectedConversation=_useState4[1];var RefConversations=useRef(conversations);var currentConversationRef=useRef(selectedConversation);var _useSocket=useSocket(),socket=_useSocket.socket,ConnectedUsers=_useSocket.ConnectedUsers;var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),typingFlag=_useState6[0],setTypingFlag=_useState6[1];var _useState7=useState(''),_useState8=_slicedToArray(_useState7,2),currentConversationIsConnected=_useState8[0],setCurrentConversationIsConnected=_useState8[1];var config={headers:{\"x-access-token\":sessionStorage[\"config\"]}};var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),showDetails=_useState10[0],setShowDetails=_useState10[1];var audio=new Audio('https://res.cloudinary.com/dsrgpqnyv/video/upload/v1630680168/juntos-607_qsfc7i.mp3');useEffect(function(){function fetchData(){return _fetchData.apply(this,arguments);}function _fetchData(){_fetchData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(socket.current==null)){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:socket.current.on('user-typing',function(_ref2){var user=_ref2.user,conversationId=_ref2.conversationId;if(selectedConversation){if(selectedConversation._id===conversationId){setTypingFlag(user.name);}}});socket.current.on('update-conversation',/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:getConversations().then(function(res){return setConversations(res);});case 1:case\"end\":return _context.stop();}}},_callee);})));case 4:case\"end\":return _context2.stop();}}},_callee2);}));return _fetchData.apply(this,arguments);}fetchData();},[selectedConversation]);useEffect(function(){function fetchData(){return _fetchData2.apply(this,arguments);}function _fetchData2(){_fetchData2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var response;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!selectedConversation){_context3.next=10;break;}if(selectedConversation.isGroup){_context3.next=10;break;}if(!ConnectedUsers.some(function(user){return user.userId===selectedConversation.Participants[0].id;})){_context3.next=6;break;}setCurrentConversationIsConnected('');_context3.next=10;break;case 6:_context3.next=8;return axios.get(\"https://messagesapp1.herokuapp.com/api/logIn/\"+selectedConversation.Participants[0].id,config);case 8:response=_context3.sent;setCurrentConversationIsConnected(response.data.LastSeen);case 10:case\"end\":return _context3.stop();}}},_callee3);}));return _fetchData2.apply(this,arguments);}fetchData();},[ConnectedUsers,selectedConversation]);useEffect(function(){function fetchData(){return _fetchData3.apply(this,arguments);}function _fetchData3(){_fetchData3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:getConversations().then(function(res){return setConversations(res);});case 1:case\"end\":return _context4.stop();}}},_callee4);}));return _fetchData3.apply(this,arguments);}fetchData();},[]);function getConversations(){return _getConversations.apply(this,arguments);}function _getConversations(){_getConversations=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){var response,ConversationsList;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;_context6.next=3;return axios.get(\"https://messagesapp1.herokuapp.com/api/conversations/UserConversations/\"+sessionStorage[\"id\"],config);case 3:response=_context6.sent;ConversationsList=response.data.map(function(conversation){var UpdatedConversation=conversation;if(!conversation.Participants.isGroup&&conversation.Name===sessionStorage[\"name\"])UpdatedConversation=_objectSpread(_objectSpread({},UpdatedConversation),{},{Name:conversation.Participants[0].name,ConversationImage:conversation.Participants[0].image});if(selectedConversation){if(selectedConversation._id===UpdatedConversation._id)setSelectedConversation(UpdatedConversation);}return UpdatedConversation;});return _context6.abrupt(\"return\",ConversationsList);case 8:_context6.prev=8;_context6.t0=_context6[\"catch\"](0);console.log(_context6.t0);case 11:case\"end\":return _context6.stop();}}},_callee6,null,[[0,8]]);}));return _getConversations.apply(this,arguments);}function getSearchConverastions(_x){return _getSearchConverastions.apply(this,arguments);}function _getSearchConverastions(){_getSearchConverastions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(str){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:getConversations().then(function(res){var SearchResult=res.filter(function(conversation){return conversation.Name.includes(str)===true;});setConversations(SearchResult);});case 1:case\"end\":return _context7.stop();}}},_callee7);}));return _getSearchConverastions.apply(this,arguments);}function createConversation(_x2,_x3,_x4,_x5){return _createConversation.apply(this,arguments);}function _createConversation(){_createConversation=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(ids,name,image,groupFlag){var ConversationImage,isGroup,ConversationExists,participants,createdDate,parts,data,response,newConversation,Response;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:ConversationImage=image;isGroup=groupFlag;//no participants chosen\nif(!(ids.length===0)){_context8.next=4;break;}return _context8.abrupt(\"return\",{status:'error',message:'no participants choosen'});case 4://check if conversation already exists and it's not a group\nConversationExists=null;if(ids.length===1&&!isGroup){ConversationExists=conversations.find(function(conversation){return conversation.Name===name;});}if(!ConversationExists){_context8.next=10;break;}setSelectedConversation(ConversationExists);//create new conversation\n_context8.next=42;break;case 10://get conversation participants\nparticipants=ids.map(function(id){var addContactToConversation=contacts.filter(function(contact){return id===contact.id;});return addContactToConversation[0];});//add creator to participants\nparticipants.push({id:info.id,name:info.name,phone:info.phone,imageName:info.imageName,LastSeen:info.LastSeen});createdDate='';//if group\nif(!isGroup){_context8.next=30;break;}parts=new Intl.DateTimeFormat('en',{hc:'h12',year:'numeric',month:'2-digit',day:'2-digit',hour:'numeric',minute:'numeric',timeZone:'Asia/Jerusalem'}).formatToParts(new Date()).reduce(function(acc,part){acc[part.type]=part.value;return acc;},Object.create(null));createdDate=\"\".concat(parts.day,\"/\").concat(parts.month,\"/\").concat(parts.year,\" \").concat(parts.hour,\":\").concat(parts.minute);data=new FormData();data.append('file',ConversationImage);data.append(\"upload_preset\",\"whatsApp_clone\");data.append(\"cloud_name\",\"dsrgpqnyv\");_context8.prev=20;_context8.next=23;return axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data);case 23:response=_context8.sent;ConversationImage=response.data.url;_context8.next=30;break;case 27:_context8.prev=27;_context8.t0=_context8[\"catch\"](20);console.log(_context8.t0);case 30:newConversation={Name:name,creatorId:sessionStorage[\"id\"],Participants:participants,Messages:[],LastMessage:{id:\"\",sender:\"\",message:\"\"},ConversationImage:ConversationImage,isGroup:isGroup,createdDate:createdDate,description:\"Add Description\"};//updateDB\n_context8.prev=31;console.log(newConversation);_context8.next=35;return axios.post(\"https://messagesapp1.herokuapp.com/api/conversations\",newConversation,config);case 35:Response=_context8.sent;if(Response.data.status===\"created\"){setSelectedConversation(Response.data.conversation);//show conversation only if messages sent\nif(Response.data.conversation.Messages.length>0)setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[Response.data.conversation]);});// }\n}_context8.next=42;break;case 39:_context8.prev=39;_context8.t1=_context8[\"catch\"](31);console.log(_context8.t1);case 42:case\"end\":return _context8.stop();}}},_callee8,null,[[20,27],[31,39]]);}));return _createConversation.apply(this,arguments);}function UpdateConversation(_x6){return _UpdateConversation.apply(this,arguments);}function _UpdateConversation(){_UpdateConversation=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(updatedConversation){var updateDBConv,addCurrentParticipant,participants,response,UpdatedConversations;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:updateDBConv=_objectSpread({},updatedConversation);if(!updatedConversation.LastMessage.message.includes('left')){addCurrentParticipant={id:info.id,phone:info.phone,name:info.name,image:info.imageName};participants=[].concat(_toConsumableArray(updatedConversation.Participants),[addCurrentParticipant]);updateDBConv=_objectSpread(_objectSpread({},updateDBConv),{},{Participants:participants});}delete updateDBConv._id;_context9.prev=3;_context9.next=6;return axios.put(\"https://messagesapp1.herokuapp.com/api/conversations/\"+selectedConversation._id,updateDBConv,config);case 6:response=_context9.sent;if(response.data.status==='Updated'){UpdatedConversations=[];if(!updatedConversation.LastMessage.message.includes('left')){console.log('in update conversations');socket.current.emit('conversation-changed',updatedConversation);setSelectedConversation(updatedConversation);conversations.forEach(function(conversation){if(conversation._id===updatedConversation._id){UpdatedConversations.push(updatedConversation);}else UpdatedConversations.push(conversation);});}else{socket.current.emit('conversation-changed',selectedConversation);console.log(conversations);UpdatedConversations=conversations.filter(function(conversation){return conversation._id!=selectedConversation._id;});setSelectedConversation();}socket.current.emit('conversation-changed',updatedConversation);setConversations(UpdatedConversations);}_context9.next=13;break;case 10:_context9.prev=10;_context9.t0=_context9[\"catch\"](3);console.log(_context9.t0);case 13:case\"end\":return _context9.stop();}}},_callee9,null,[[3,10]]);}));return _UpdateConversation.apply(this,arguments);}var addMessageToConversation=useCallback(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(_ref4){var UpdatedConv,ConversationExists,newListOfConversations,newConversation;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:UpdatedConv=_ref4.UpdatedConv;audio.play();ConversationExists=false;newListOfConversations=RefConversations.current.map(function(conversation){if(conversation._id===UpdatedConv._id){ConversationExists=true;var newConv=_objectSpread(_objectSpread({},conversation),{},{Messages:UpdatedConv.Messages,LastMessage:UpdatedConv.LastMessage});if(currentConversationRef.current){if(currentConversationRef.current._id===UpdatedConv._id)setSelectedConversation(newConv);}return newConv;}else return conversation;});if(!ConversationExists){if(!UpdatedConv.isGroup){newConversation=_objectSpread(_objectSpread({},UpdatedConv),{},{Name:UpdatedConv.Participants[0].name,ConversationImage:UpdatedConv.Participants[0].imageName});setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[newConversation]);});}else setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[UpdatedConv]);});}else setConversations(newListOfConversations);case 5:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x7){return _ref5.apply(this,arguments);};}(),[setConversations]);useEffect(function(){if(socket.current==null)return;RefConversations.current=conversations;currentConversationRef.current=selectedConversation;socket.current.on(\"receive-message\",addMessageToConversation);return function(){return socket.current.off(\"receive-message\",addMessageToConversation);};},[conversations,selectedConversation]);var updateSenderConversation=function updateSenderConversation(AddMessage){var ConversationExists=false;setSelectedConversation(AddMessage);var newListOfConcversations=conversations.map(function(conversation){if(conversation._id===AddMessage._id){ConversationExists=true;return AddMessage;}else return conversation;});if(ConversationExists){setConversations(newListOfConcversations);}else setConversations(function(prevConversations){return[].concat(_toConsumableArray(prevConversations),[AddMessage]);});};function sendMessage(text,imageFlag,imageURL,recordURL){var parts=new Intl.DateTimeFormat('en',{hc:'h12',year:'numeric',month:'2-digit',day:'2-digit',hour:'numeric',minute:'numeric',timeZone:'Asia/Jerusalem'}).formatToParts(new Date()).reduce(function(acc,part){acc[part.type]=part.value;return acc;},Object.create(null));var time=\"\".concat(parts.day,\"/\").concat(parts.month,\"/\").concat(parts.year,\"  \").concat(parts.hour,\":\").concat(parts.minute);var recordFlag=false;if(recordURL!=null)recordFlag=true;var CurrentMessage={id:info.id,name:info.name,message:text,timeSent:time,containsImage:imageFlag,containsRecord:recordFlag,recordURL:recordURL};if(imageFlag===true)CurrentMessage=_objectSpread(_objectSpread({},CurrentMessage),{},{imageURL:imageURL});var sender={id:info.id,phone:info.phone,name:info.name,image:info.imageName};var AddMessage=_objectSpread(_objectSpread({},selectedConversation),{},{Messages:[].concat(_toConsumableArray(selectedConversation.Messages),[CurrentMessage]),LastMessage:CurrentMessage});socket.current.emit(\"send-message\",{sender:sender,UpdatedConversation:AddMessage,conversationId:selectedConversation._id});updateSenderConversation(AddMessage);}return/*#__PURE__*/_jsx(ConversationsContext.Provider,{value:{sendMessage:sendMessage,conversations:conversations,createConversation:createConversation,setConversations:setConversations,setSelectedConversation:setSelectedConversation,selectedConversation:selectedConversation,currentConversationIsConnected:currentConversationIsConnected,typingFlag:typingFlag,setTypingFlag:setTypingFlag,getSearchConverastions:getSearchConverastions,showDetails:showDetails,setShowDetails:setShowDetails,UpdateConversation:UpdateConversation},children:children});}","map":{"version":3,"sources":["C:/Users/User/OneDrive/Desktop/whatsapp/myclient/src/contexts/conversationsprovider.js"],"names":["React","useContext","useCallback","useRef","useState","useEffect","useUser","useSocket","axios","Conversations","ConversationsContext","createContext","useConversations","ConversationsProvider","id","children","contacts","info","conversations","setConversations","selectedConversation","setSelectedConversation","RefConversations","currentConversationRef","socket","ConnectedUsers","typingFlag","setTypingFlag","currentConversationIsConnected","setCurrentConversationIsConnected","config","headers","sessionStorage","showDetails","setShowDetails","audio","Audio","fetchData","current","on","user","conversationId","_id","name","getConversations","then","res","isGroup","some","userId","Participants","get","response","data","LastSeen","ConversationsList","map","conversation","UpdatedConversation","Name","ConversationImage","image","console","log","getSearchConverastions","str","SearchResult","filter","includes","createConversation","ids","groupFlag","length","status","message","ConversationExists","find","participants","addContactToConversation","contact","push","phone","imageName","createdDate","parts","Intl","DateTimeFormat","hc","year","month","day","hour","minute","timeZone","formatToParts","Date","reduce","acc","part","type","value","Object","create","FormData","append","post","url","newConversation","creatorId","Messages","LastMessage","sender","description","Response","prevConversations","UpdateConversation","updatedConversation","updateDBConv","addCurrentParticipant","put","UpdatedConversations","emit","forEach","addMessageToConversation","UpdatedConv","play","newListOfConversations","newConv","off","updateSenderConversation","AddMessage","newListOfConcversations","sendMessage","text","imageFlag","imageURL","recordURL","time","recordFlag","CurrentMessage","timeSent","containsImage","containsRecord"],"mappings":"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","sourcesContent":["import React, { useContext, useCallback, useRef } from \"react\";\r\nimport { useState, useEffect } from \"react\";\r\nimport { useUser } from \"./userprovider\";\r\nimport { useSocket } from \"./socketprovider\";\r\nimport axios from \"axios\";\r\nimport Conversations from \"../components/conversations\";\r\n\r\n\r\nconst ConversationsContext = React.createContext();\r\n\r\nexport function useConversations() {\r\n  return useContext(ConversationsContext);\r\n}\r\n\r\nexport function ConversationsProvider({ id, children }) {\r\n  const {contacts, info} = useUser();\r\n  const [conversations, setConversations] = useState([]);\r\n  const [selectedConversation, setSelectedConversation] = useState();\r\n  const RefConversations = useRef(conversations);\r\n  const currentConversationRef = useRef(selectedConversation);\r\n  const { socket, ConnectedUsers } = useSocket();\r\n  const [typingFlag,setTypingFlag] =useState('')\r\n  const [currentConversationIsConnected,setCurrentConversationIsConnected] = useState('')\r\n  const config = { headers: { \"x-access-token\": sessionStorage[\"config\"] } };\r\n  const [showDetails,setShowDetails] =useState(false)\r\n\r\n  const audio = new Audio('https://res.cloudinary.com/dsrgpqnyv/video/upload/v1630680168/juntos-607_qsfc7i.mp3');\r\n\r\n\r\n  useEffect(()=>{\r\n\r\n    async function fetchData() {\r\n\r\n    if(socket.current ==null ) return;\r\n    socket.current.on('user-typing',({user,conversationId})=>\r\n    {\r\n\r\n        if(selectedConversation)\r\n        {\r\n          if(selectedConversation._id === conversationId)\r\n          {\r\n             setTypingFlag(user.name)\r\n          }\r\n        }\r\n    } )\r\n\r\n    socket.current.on('update-conversation',async ()=>\r\n    {\r\n      getConversations().then(res=> setConversations(res))\r\n    \r\n    })\r\n  }\r\n  fetchData();\r\n  },[selectedConversation])\r\n\r\n  useEffect( ()=>\r\n  {\r\n    async function fetchData() {\r\n    if(selectedConversation)\r\n    {\r\n    if(!selectedConversation.isGroup)\r\n     {\r\n      if(ConnectedUsers.some(user=> user.userId ===selectedConversation.Participants[0].id))\r\n      {\r\n        setCurrentConversationIsConnected('')\r\n      }\r\n      else\r\n      {\r\n        let response = await axios.get(\"https://messagesapp1.herokuapp.com/api/logIn/\"+ selectedConversation.Participants[0].id,config)\r\n        setCurrentConversationIsConnected(response.data.LastSeen)\r\n      }\r\n     }\r\n    }\r\n  }\r\n  fetchData();\r\n\r\n  },[ConnectedUsers,selectedConversation])\r\n\r\n  useEffect(() =>\r\n  {\r\n    async function fetchData() {\r\n     getConversations().then(res=> setConversations(res))\r\n    }\r\n    fetchData();\r\n    \r\n  }, []);\r\n\r\n  async function getConversations()\r\n  {\r\n    try{\r\n       let response = await axios.get(\"https://messagesapp1.herokuapp.com/api/conversations/UserConversations/\" +sessionStorage[\"id\"],config);\r\n       let ConversationsList = response.data.map((conversation) =>\r\n       {\r\n         let UpdatedConversation= conversation\r\n         if (!conversation.Participants.isGroup && conversation.Name === sessionStorage[\"name\"])\r\n            UpdatedConversation = { ...UpdatedConversation,Name: conversation.Participants[0].name,ConversationImage:conversation.Participants[0].image}\r\n\r\n         if(selectedConversation)\r\n         {\r\n           if(selectedConversation._id === UpdatedConversation._id)\r\n              setSelectedConversation(UpdatedConversation)\r\n         }\r\n          \r\n         return UpdatedConversation;\r\n       })\r\n\r\n      return ConversationsList \r\n    } catch (err) {console.log(err);}\r\n  }\r\n\r\n\r\n\r\n\r\n  async function getSearchConverastions(str)\r\n  {\r\n\r\n        getConversations().then(res=>\r\n        {\r\n\r\n         let SearchResult = res.filter(conversation=> \r\n            conversation.Name.includes(str) ===true\r\n          )\r\n    \r\n          setConversations(SearchResult)\r\n        })\r\n  }\r\n        \r\n\r\n\r\n  async function createConversation(ids, name, image,groupFlag) {\r\n    let ConversationImage = image;\r\n    let isGroup = groupFlag;\r\n\r\n\r\n    //no participants chosen\r\n    if (ids.length === 0) {\r\n      return {status:'error',message:'no participants choosen'};\r\n    }\r\n\r\n    //check if conversation already exists and it's not a group\r\n    let ConversationExists = null;\r\n    if (ids.length === 1 && !isGroup) {\r\n      ConversationExists = conversations.find(\r\n        (conversation) => conversation.Name === name\r\n      );\r\n    }\r\n\r\n    if (ConversationExists) setSelectedConversation(ConversationExists);\r\n\r\n    //create new conversation\r\n    else {\r\n\r\n      //get conversation participants\r\n      const participants = ids.map((id) => {\r\n        let addContactToConversation = contacts.filter(\r\n          (contact) => id === contact.id\r\n        );\r\n        return addContactToConversation[0];\r\n      });\r\n\r\n\r\n      //add creator to participants\r\n      participants.push({\r\n        id: info.id,\r\n        name: info.name,\r\n        phone: info.phone,\r\n        imageName: info.imageName,\r\n        LastSeen: info.LastSeen\r\n      });\r\n\r\n      let createdDate=''\r\n\r\n      //if group\r\n      \r\n      if (isGroup) {\r\n\r\n\r\n        let parts = new Intl.DateTimeFormat('en', {\r\n          hc: 'h12',\r\n          year: 'numeric',\r\n          month: '2-digit',\r\n          day: '2-digit',\r\n          hour: 'numeric',\r\n          minute: 'numeric',\r\n          timeZone:'Asia/Jerusalem'})\r\n        .formatToParts(new Date())\r\n        .reduce((acc, part) => {\r\n          acc[part.type] = part.value;\r\n          return acc;\r\n        }, Object.create(null));\r\n\r\n       \r\n    \r\n        createdDate= `${parts.day}/${parts.month}/${parts.year} ${parts.hour}:${parts.minute}`;\r\n\r\n        const data = new FormData()\r\n        data.append('file',ConversationImage)\r\n        data.append(\"upload_preset\",\"whatsApp_clone\")\r\n        data.append(\"cloud_name\",\"dsrgpqnyv\")\r\n        try{\r\n        let response = await axios.post(\"https://api.cloudinary.com/v1_1/dsrgpqnyv/image/upload\",data)\r\n        ConversationImage = response.data.url;\r\n\r\n        }catch(err){console.log(err)}\r\n   \r\n      }\r\n \r\n    \r\n      let newConversation = {\r\n        Name: name,\r\n        creatorId: sessionStorage[\"id\"],\r\n        Participants: participants,\r\n        Messages: [],\r\n        LastMessage: { id: \"\", sender: \"\", message: \"\" },\r\n        ConversationImage: ConversationImage,\r\n        isGroup:isGroup,\r\n        createdDate:createdDate,\r\n        description: \"Add Description\",\r\n      };\r\n\r\n      //updateDB\r\n      try {\r\n        console.log(newConversation)\r\n        let Response = await axios.post(\r\n          \"https://messagesapp1.herokuapp.com/api/conversations\",\r\n          newConversation,\r\n          config\r\n        );\r\n\r\n        if (Response.data.status === \"created\") {\r\n          setSelectedConversation(Response.data.conversation);\r\n\r\n          //show conversation only if messages sent\r\n          if (Response.data.conversation.Messages.length > 0)\r\n            setConversations((prevConversations) => {\r\n              return [...prevConversations, Response.data.conversation];\r\n            });\r\n          // }\r\n        }\r\n      } catch (err) {\r\n        console.log(err);\r\n      }\r\n    }\r\n  }\r\n\r\n  async function UpdateConversation(updatedConversation)\r\n  {\r\n\r\n    let updateDBConv={...updatedConversation}\r\n    if(!(updatedConversation.LastMessage.message.includes('left')))\r\n    {\r\n      let addCurrentParticipant= {id: info.id,phone: info.phone,name: info.name,image: info.imageName,}\r\n      let participants=[...updatedConversation.Participants,addCurrentParticipant]\r\n      updateDBConv={...updateDBConv,Participants:participants}\r\n    }\r\n    delete updateDBConv._id\r\n\r\n\r\n      try{\r\n        let response=await axios.put(\"https://messagesapp1.herokuapp.com/api/conversations/\"+ selectedConversation._id,updateDBConv,config)\r\n        if(response.data.status==='Updated')\r\n        {\r\n\r\n          let UpdatedConversations=[]\r\n         if(!(updatedConversation.LastMessage.message.includes('left')))\r\n         {\r\n\r\n          console.log('in update conversations')\r\n          socket.current.emit('conversation-changed',updatedConversation)\r\n          setSelectedConversation(updatedConversation)\r\n        \r\n           conversations.forEach(conversation=>\r\n            {\r\n              \r\n              if(conversation._id===updatedConversation._id)\r\n              {\r\n                   \r\n                  UpdatedConversations.push(updatedConversation)\r\n              }\r\n              else UpdatedConversations.push(conversation)\r\n            })\r\n          }\r\n          else\r\n          {\r\n            socket.current.emit('conversation-changed',selectedConversation)\r\n            console.log(conversations)\r\n             UpdatedConversations=conversations.filter(conversation=> conversation._id != selectedConversation._id)\r\n             setSelectedConversation()\r\n          }\r\n\r\n            socket.current.emit('conversation-changed',updatedConversation)\r\n\r\n\r\n\r\n            setConversations(UpdatedConversations)\r\n          \r\n            \r\n        }\r\n      }catch(err){console.log(err)}\r\n  }\r\n\r\n \r\n\r\n  const addMessageToConversation = useCallback(async ({ UpdatedConv }) =>\r\n   {\r\n\r\n      audio.play()\r\n\r\n      let ConversationExists = false;\r\n      let newListOfConversations = RefConversations.current.map((conversation) =>{\r\n          if (conversation._id === UpdatedConv._id) {\r\n            ConversationExists = true;\r\n            let newConv = { ...conversation,\r\n              Messages: UpdatedConv.Messages,\r\n              LastMessage: UpdatedConv.LastMessage,};\r\n            if (currentConversationRef.current) {\r\n              if (currentConversationRef.current._id === UpdatedConv._id)\r\n                setSelectedConversation(newConv);\r\n            }\r\n\r\n            return newConv;\r\n          } else return conversation;\r\n        }\r\n      );\r\n\r\n\r\n      if (!ConversationExists) {\r\n        if (!UpdatedConv.isGroup)\r\n         {\r\n           let newConversation = { ...UpdatedConv,\r\n            Name: UpdatedConv.Participants[0].name,\r\n            ConversationImage: UpdatedConv.Participants[0].imageName,\r\n          };\r\n          setConversations((prevConversations) => [...prevConversations, newConversation ]);\r\n        } else\r\n          setConversations((prevConversations) => [...prevConversations,UpdatedConv]);\r\n      } else setConversations(newListOfConversations);\r\n    },[setConversations]);\r\n\r\n  useEffect(() => {\r\n    if (socket.current == null) return;\r\n    \r\n    RefConversations.current = conversations;\r\n    currentConversationRef.current = selectedConversation;\r\n    socket.current.on(\"receive-message\", addMessageToConversation);\r\n\r\n    return () =>\r\n      socket.current.off(\"receive-message\", addMessageToConversation);\r\n  }, [conversations, selectedConversation]);\r\n\r\n\r\n  const updateSenderConversation = (AddMessage) => {\r\n    let ConversationExists = false;\r\n    setSelectedConversation(AddMessage);\r\n\r\n    let newListOfConcversations = conversations.map((conversation) => {\r\n      if (conversation._id === AddMessage._id) {\r\n        ConversationExists = true;\r\n        return AddMessage;\r\n      } else return conversation;\r\n    });\r\n\r\n    if (ConversationExists) {\r\n      setConversations(newListOfConcversations);\r\n    } else\r\n      setConversations((prevConversations) => [\r\n        ...prevConversations,\r\n        AddMessage,\r\n      ]);\r\n  };\r\n\r\n\r\n  function sendMessage(text,imageFlag,imageURL,recordURL) {\r\n\r\n\r\n      let parts = new Intl.DateTimeFormat('en', {\r\n      hc: 'h12',\r\n      year: 'numeric',\r\n      month: '2-digit',\r\n      day: '2-digit',\r\n      hour: 'numeric',\r\n      minute: 'numeric',\r\n      timeZone:'Asia/Jerusalem'})\r\n    .formatToParts(new Date())\r\n    .reduce((acc, part) => {\r\n      acc[part.type] = part.value;\r\n      return acc;\r\n    }, Object.create(null));\r\n\r\n    let time = `${parts.day}/${parts.month}/${parts.year}  ${parts.hour}:${parts.minute}`;\r\n\r\n    let recordFlag= false\r\n\r\n    if(recordURL!=null)\r\n       recordFlag=true\r\n    \r\n    let CurrentMessage = { id: info.id, name: info.name, message: text  ,timeSent: time ,containsImage: imageFlag,containsRecord:recordFlag,recordURL:recordURL};\r\n    if(imageFlag ===true)\r\n       CurrentMessage= {...CurrentMessage,imageURL:imageURL}\r\n    \r\n    let sender = {\r\n      id: info.id,\r\n      phone: info.phone,\r\n      name: info.name,\r\n      image: info.imageName,\r\n    };\r\n    let AddMessage = {\r\n      ...selectedConversation,\r\n      Messages: [...selectedConversation.Messages, CurrentMessage],\r\n      LastMessage: CurrentMessage,\r\n    };\r\n    socket.current.emit(\"send-message\", {\r\n      sender: sender,\r\n      UpdatedConversation: AddMessage,\r\n      conversationId: selectedConversation._id,\r\n    });\r\n\r\n    updateSenderConversation(AddMessage);\r\n  }\r\n\r\n  return (\r\n    <ConversationsContext.Provider\r\n      value={{\r\n        sendMessage,\r\n        conversations,\r\n        createConversation,\r\n        setConversations,\r\n        setSelectedConversation,\r\n        selectedConversation,\r\n        currentConversationIsConnected,\r\n        typingFlag,\r\n        setTypingFlag,\r\n        getSearchConverastions,\r\n        showDetails,\r\n        setShowDetails,\r\n        UpdateConversation\r\n      \r\n      }}\r\n    >\r\n      {children}\r\n    </ConversationsContext.Provider>\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}